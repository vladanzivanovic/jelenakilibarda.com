<?php

declare(strict_types=1);

namespace App\Parser;

use App\Entity\Description;
use App\Entity\DescriptionTranslation;
use App\Entity\EntityInterface;
use App\Handler\ImageHandler;
use App\Repository\BiographyHasImagesRepository;
use App\Repository\BiographyTranslationRepository;
use Symfony\Component\HttpFoundation\ParameterBag;

class BiographyRequestParser implements RequestParserInterface
{
    private BiographyTranslationRepository $translationRepository;

    private ImageHandler $imageHandler;

    private BiographyHasImagesRepository $hasImagesRepository;

    private array $languages;

    private string $defaultLocale;

    public function __construct(
        BiographyTranslationRepository $translationRepository,
        ImageHandler $imageHandler,
        BiographyHasImagesRepository $hasImagesRepository,
        array $languages,
        string $defaultLocale
    ) {
        $this->translationRepository = $translationRepository;
        $this->languages = $languages;
        $this->imageHandler = $imageHandler;
        $this->defaultLocale = $defaultLocale;
        $this->hasImagesRepository = $hasImagesRepository;
    }

    /**
     * @throws \Doctrine\ORM\ORMException
     */
    public function parse(ParameterBag $bag, EntityInterface $entity = null): Description
    {
        if (!$entity instanceof Description) {
            $entity = $this->create();
            $entity->setType($bag->get('type'));
        }

        $this->setTranslation($entity, $bag);

        $this->imageHandler->setImages(
            $entity,
            json_decode($bag->get('images'), true),
            $this->hasImagesRepository
        );

        return $entity;
    }

    public function create(): Description
    {
        return new Description();
    }

    private function setTranslation(Description $biography, ParameterBag $bag)
    {
        foreach ($this->languages as $language) {
            $langCode = $language['code'];

            $translation = $this->translationRepository->findOneBy(['entity' => $biography, 'locale' => $langCode]);

            if (!$translation instanceof DescriptionTranslation) {
                $translation = $biography->createTranslation();
                $this->translationRepository->persist($translation);
            }

            $translation->setLocale($langCode);
            $translation->setShortDescription($bag->get('short_description_'.$langCode));
            $translation->setDescription($bag->get('description_'.$langCode));

            $biography->addTranslation($translation);
        }
    }
}
